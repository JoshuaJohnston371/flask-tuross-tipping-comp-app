<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Submit Tip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .team-logo {
      width: 60px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .team-logo:hover {
      transform: scale(1.1);
    }
    .selected {
      border: 3px solid #28a745;
      border-radius: 10px;
    }
    .team-label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    .report-body {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.75rem;
      text-align: left;
      font-size: 0.9rem;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid #e3e3e3;
    }
    .report-content {
      white-space: pre-wrap;
    }
    .report-loading,
    .report-error {
      color: #6c757d;
    }
    @media (max-width: 576px) {
      .team-logo {
        width: 50px;
      }
      .team-label {
        font-size: 0.8rem;
      }
      h2 {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <h2 class="text-center mb-4">Submit Your Tips - Round Fixtures</h2>

    {% if has_submitted %}
      <div class="alert alert-info text-center">
        You have already submitted your tips for this round.
      </div>

      <div class="row">
        {% for tip in submitted_tips %}
          <div class="col-12 col-md-6 mb-4">
            <div class="card p-3 text-center">
              <div class="d-flex justify-content-center align-items-center">
                <img src="{{ team_logos[tip.selected_team] }}" 
                     class="team-logo selected" 
                     alt="{{ tip.selected_team }}">
              </div>
              <div class="mt-2">
                You tipped: <strong>{{ tip.selected_team }}</strong>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="text-center mt-4">
        <a href="{{ url_for('main.home') }}" class="btn btn-secondary">Go back to homepage</a>
      </div>

    {% else %}
      <form id="tip-form" method="POST">
        <div class="row">
          {% for fixture in fixtures %}
            <div class="col-12 col-md-6 mb-4">
              <div class="card p-3 text-center">
                <div class="mb-2">
                  <strong>{{ fixture.date.strftime("%A %d %B") }}</strong>
                </div>
                <div class="d-flex flex-wrap justify-content-center align-items-center gap-3">
                  <div class="text-center">
                    <div class="team-label">Home</div>
                    <img src="{{ team_logos[fixture.home_team] }}" 
                         class="team-logo" 
                         alt="{{ fixture.home_team }}" 
                         data-match="{{ fixture.match_id }}" 
                         data-team="{{ fixture.home_team }}">
                  </div>

                  <div class="fw-bold">vs</div>

                  <div class="text-center">
                    <div class="team-label">Away</div>
                    <img src="{{ team_logos[fixture.away_team] }}" 
                         class="team-logo" 
                         alt="{{ fixture.away_team }}" 
                         data-match="{{ fixture.match_id }}" 
                         data-team="{{ fixture.away_team }}">
                  </div>
                </div>

                <input type="hidden" name="team-input-{{ fixture.match_id }}" id="team-input-{{ fixture.match_id }}">

                <div class="mt-3">
                  <button class="btn btn-outline-primary btn-sm w-100 report-toggle"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#report-{{ fixture.match_id }}"
                          aria-expanded="false"
                          aria-controls="report-{{ fixture.match_id }}">
                    {% if report_match_ids and (fixture.match_id|string) in report_match_ids %}
                      Show report
                    {% else %}
                      Create Intelligence Report
                    {% endif %}
                  </button>
                  <div class="collapse mt-3 report-collapse"
                       id="report-{{ fixture.match_id }}"
                       data-report-url="{{ url_for('tip.tip_report', match_id=fixture.match_id) }}"
                       data-has-report="{% if report_match_ids and (fixture.match_id|string) in report_match_ids %}true{% else %}false{% endif %}">
                    <div class="report-body">
                      <div class="report-loading d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></div>
                        <span>Loading report...</span>
                      </div>
                      <div class="mt-2 d-none report-actions">
                        <button class="btn btn-outline-secondary btn-sm w-100 report-cancel" type="button">
                          Cancel
                        </button>
                      </div>
                      <div class="report-content"></div>
                      <div class="report-error d-none">Report not available right now.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="text-center mt-4">
          <button type="button" class="btn btn-primary btn-lg w-100" onclick="confirmSubmission()">Submit Tips</button>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to submit your tips? You won't be able to change them after.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-success" onclick="submitForm()">Yes, Submit</button>
              </div>
            </div>
          </div>
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="{{ url_for('main.home') }}" class="btn btn-secondary">Go back to homepage</a>
      </div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <script>
    document.querySelectorAll('.team-logo').forEach(img => {
      img.addEventListener('click', function () {
        const matchId = this.dataset.match;
        document.querySelectorAll(`[data-match='${matchId}']`).forEach(el => {
          el.classList.remove('selected');
        });
        this.classList.add('selected');
        document.getElementById(`team-input-${matchId}`).value = this.dataset.team;
      });
    });

    function confirmSubmission() {
      const allInputs = document.querySelectorAll("input[type='hidden'][id^='team-input-']");
      let allFilled = true;
      allInputs.forEach(input => {
        if (!input.value) {
          allFilled = false;
        }
      });

      if (!allFilled) {
        alert("Please select a team for all matches.");
        return;
      }

      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      modal.show();
    }

    function submitForm() {
      document.getElementById('tip-form').submit();
    }

    function updateReportToggle(collapseEl, state) {
      const toggleButton = collapseEl.closest('.card').querySelector('.report-toggle');
      if (!toggleButton) {
        return;
      }
      if (state === 'creating') {
        toggleButton.textContent = 'Generating report...';
        toggleButton.disabled = true;
      } else if (state === 'open') {
        toggleButton.textContent = 'Close report';
        toggleButton.disabled = false;
      } else if (state === 'closed') {
        toggleButton.textContent = 'Show report';
        toggleButton.disabled = false;
      } else {
        toggleButton.textContent = 'Create Intelligence Report';
        toggleButton.disabled = false;
      }
    }

    function scheduleReportPoll(collapseEl, delayMs = 2000) {
      if (collapseEl._reportTimeout) {
        clearTimeout(collapseEl._reportTimeout);
      }
      collapseEl._reportTimeout = setTimeout(() => {
        fetchReport(collapseEl);
      }, delayMs);
    }

    async function fetchReport(collapseEl) {
      const reportContent = collapseEl.querySelector('.report-content');
      const reportLoading = collapseEl.querySelector('.report-loading');
      const reportError = collapseEl.querySelector('.report-error');
      const reportActions = collapseEl.querySelector('.report-actions');
      let isPending = false;
      if (reportContent.dataset.loaded === 'true') {
        return;
      }

      reportLoading.classList.remove('d-none');
      reportError.classList.add('d-none');
      reportActions.classList.remove('d-none');
      updateReportToggle(collapseEl, 'creating');
      reportContent.textContent = '';

      try {
        const controller = new AbortController();
        if (collapseEl._reportAbort) {
          collapseEl._reportAbort.abort();
        }
        collapseEl._reportAbort = controller;
        const timeoutId = setTimeout(() => controller.abort(), 25000);
        const response = await fetch(collapseEl.dataset.reportUrl, {
          headers: { 'Accept': 'application/json' },
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const contentType = response.headers.get('content-type') || '';
        let data = null;

        if (contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          throw new Error(text || `Report fetch failed: ${response.status}`);
        }

        if (response.status === 202) {
          isPending = true;
          reportLoading.classList.remove('d-none');
          updateReportToggle(collapseEl, 'creating');
          scheduleReportPoll(collapseEl, 2000);
          return;
        }

        if (!response.ok) {
          const details = data.traceback ? `\n\n${data.traceback}` : '';
          throw new Error((data.error || `Report fetch failed: ${response.status}`) + details);
        }

        const markdown = data.report || 'Report not available right now.';
        const rendered = window.marked ? window.marked.parse(markdown) : markdown;
        reportContent.innerHTML = window.DOMPurify ? window.DOMPurify.sanitize(rendered) : rendered;
        reportContent.dataset.loaded = 'true';
        collapseEl.dataset.hasReport = 'true';
        reportActions.classList.add('d-none');
        updateReportToggle(collapseEl, 'open');
      } catch (error) {
        reportError.textContent = error.message || 'Report not available right now.';
        reportError.classList.remove('d-none');
        reportActions.classList.add('d-none');
        updateReportToggle(collapseEl, 'default');
      } finally {
        if (!isPending) {
          reportLoading.classList.add('d-none');
        }
      }
    }

    document.querySelectorAll('.report-collapse').forEach(collapseEl => {
      if (collapseEl.dataset.hasReport === 'true') {
        updateReportToggle(collapseEl, 'closed');
      }
      const cancelButton = collapseEl.querySelector('.report-cancel');
      if (cancelButton) {
        cancelButton.addEventListener('click', async () => {
          if (collapseEl._reportTimeout) {
            clearTimeout(collapseEl._reportTimeout);
            collapseEl._reportTimeout = null;
          }
          if (collapseEl._reportAbort) {
            collapseEl._reportAbort.abort();
            collapseEl._reportAbort = null;
          }
          try {
            await fetch(`${collapseEl.dataset.reportUrl}/cancel`, {
              method: 'POST',
              headers: { 'Accept': 'application/json' }
            });
          } catch (error) {
            // ignore cancel errors
          }
          const reportContent = collapseEl.querySelector('.report-content');
          const reportLoading = collapseEl.querySelector('.report-loading');
          const reportError = collapseEl.querySelector('.report-error');
          const reportActions = collapseEl.querySelector('.report-actions');
          reportLoading.classList.add('d-none');
          reportActions.classList.add('d-none');
          reportError.classList.remove('d-none');
          reportError.textContent = 'Report generation cancelled.';
          reportContent.textContent = '';
          updateReportToggle(collapseEl, 'default');
        });
      }
      collapseEl.addEventListener('show.bs.collapse', () => {
        fetchReport(collapseEl);
      });
      collapseEl.addEventListener('hide.bs.collapse', () => {
        if (collapseEl._reportTimeout) {
          clearTimeout(collapseEl._reportTimeout);
          collapseEl._reportTimeout = null;
        }
        if (collapseEl._reportAbort) {
          collapseEl._reportAbort.abort();
          collapseEl._reportAbort = null;
        }
        if (collapseEl.dataset.hasReport === 'true') {
          updateReportToggle(collapseEl, 'closed');
        } else {
          updateReportToggle(collapseEl, 'default');
        }
      });
    });
  </script>
</body>
</html>
